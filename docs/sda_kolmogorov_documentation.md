# sda/kolmogorov ディレクトリ解説

## 概要
このディレクトリは、Kolmogorov流（2次元乱流）のシミュレーションと、スコアベース拡散モデル（Score-based Diffusion Models）を用いたデータ同化実験のためのコードベースです。主に物理シミュレーションデータの生成、深層学習モデルの訓練、そして様々なデータ同化タスクの実行を行います。

## ディレクトリ構造

```
sda/experiments/kolmogorov/
├── __init__.py          # パッケージ初期化ファイル
├── generate.py          # データ生成スクリプト
├── train.py            # モデル訓練スクリプト
├── utils.py            # ユーティリティ関数群
├── figures.ipynb       # 実験結果の可視化（メイン）
├── figures_bis.ipynb   # 追加の可視化実験
└── sandwich.ipynb      # サンドイッチアプローチの実験
```

## 各ファイルの詳細解説

### 1. **generate.py** - データ生成モジュール

#### 主要機能
- Kolmogorov流のシミュレーションを実行し、訓練用データセットを生成

#### 主要関数

##### `simulate(i: int)`
- **役割**: 個別のKolmogorov流シミュレーションを実行
- **処理フロー**:
  1. `make_chain()`でKolmogorov流シミュレータを初期化
  2. ランダムシードを設定（`i`で制御）
  3. 初期条件を生成（`chain.prior()`）
  4. 128ステップの時間発展を計算
  5. 最初の64ステップを破棄（過渡応答除去）
  6. 結果を`.npy`ファイルとして保存
- **並列実行**: 1024個のジョブを並列実行可能

##### `aggregate()`
- **役割**: 個別シミュレーション結果を集約し、訓練/検証/テスト用データセットを作成
- **処理フロー**:
  1. 全ての個別シミュレーションファイルを収集
  2. 80%/10%/10%の比率でデータを分割
  3. 空間解像度を4分の1に粗視化（256×256 → 64×64）
  4. HDF5形式で保存（効率的な大規模データアクセス用）

### 2. **train.py** - モデル訓練モジュール

#### 主要機能
- スコアベース拡散モデルの訓練を実行
- Weights & Biases (wandb)での実験管理

#### 設定パラメータ（CONFIG）
```python
CONFIG = {
    'window': 4,        # 時間窓サイズ
    'kernel': 2,        # カーネルサイズ
    'width': 96,        # ネットワーク幅
    # その他の訓練パラメータ
}
```

#### `train(i: int)`関数
- **役割**: スコアネットワークの訓練を実行
- **処理フロー**:
  1. wandbで実験を初期化
  2. U-Netベースのスコアネットワークを構築（`LocalScoreUNet`）
  3. VPSDEを用いた拡散過程を設定
  4. 訓練/検証データセットをロード
  5. 訓練ループを実行（損失の最小化）
  6. モデルの重みを保存
  7. サンプル生成で品質を評価

### 3. **utils.py** - ユーティリティ関数群

#### 主要コンポーネント

##### `LocalScoreUNet`クラス
- **役割**: 強制項を考慮したU-Netスコアネットワーク
- **特徴**:
  - Kolmogorov流の強制項（sin(4y)）を組み込み
  - 物理的な制約を考慮したアーキテクチャ

##### `make_chain()`
- **役割**: Kolmogorov流シミュレータの初期化
- **パラメータ**:
  - `size=256`: グリッドサイズ
  - `dt=0.2`: 時間刻み幅

##### `make_score()`
- **役割**: スコアネットワークの構築
- **入力**: kernel, width等の設定パラメータ

##### `load_score(path)`
- **役割**: 訓練済みモデルのロード

##### 可視化関数群
- `vorticity2rgb()`: 渦度場をRGB画像に変換
- `draw()`: 流れ場の可視化
- `sandwich()`: サンドイッチ法による可視化
- `save_gif()`: アニメーション生成

### 4. **figures.ipynb** - メイン実験ノートブック

#### 実験内容

##### 1. Circle実験
- **目的**: 円形マスクでの条件付きサンプリング
- **手法**: 渦度場の特定領域を制約として生成

##### 2. Assimilation（データ同化）
- **目的**: 観測データからの完全な流れ場の推定
- **観測モデル**: 空間的な粗視化（ダウンサンプリング）
- **比較手法**:
  - SDA（Score-based Data Assimilation）
  - DPS（Diffusion Posterior Sampling）

##### 3. Extrapolation（外挿）
- **目的**: 部分的な観測から全体場を推定
- **観測**: 時空間的にスパースな観測（3時刻、中心8×8領域）

##### 4. Non-linear observation（非線形観測）
- **目的**: 非線形観測過程での推定
- **観測モデル**: 渦度の飽和効果を含む観測

##### 5. Subsampling（サブサンプリング）
- **目的**: 異なる解像度での観測からの推定
- **実験**: 2倍、4倍、8倍、16倍のダウンサンプリング

##### 6. Loop（周期境界条件）
- **目的**: 時間的な周期性を持つ流れの生成
- **制約**: 初期状態と最終状態の一致

## 主要な処理フロー

### データ生成フロー
```
1. simulate() × 1024並列実行
   ↓
2. 個別シミュレーション結果（.npy）
   ↓
3. aggregate()で集約・前処理
   ↓
4. train.h5, valid.h5, test.h5
```

### モデル訓練フロー
```
1. データセットのロード
   ↓
2. LocalScoreUNetの初期化
   ↓
3. VPSDEによる拡散過程設定
   ↓
4. 訓練ループ（損失最小化）
   ↓
5. モデル保存 & 評価
```

### データ同化フロー
```
1. 観測データy*の準備
   ↓
2. 観測演算子A(x)の定義
   ↓
3. スコアベース同化（SDA/DPS）
   ↓
4. サンプリング（逆拡散過程）
   ↓
5. 推定結果xの取得
```

## 技術的特徴

### 1. **物理シミュレーション**
- Kolmogorov流（2次元乱流の標準的なベンチマーク）
- スペクトル法による高精度シミュレーション
- 多重解像度表現（粗視化による階層的表現）

### 2. **深層学習モデル**
- U-Netアーキテクチャによるスコア関数の学習
- VPSDE（Variance Preserving SDE）による拡散過程
- 物理的制約（強制項）の組み込み

### 3. **データ同化手法**
- スコアベースデータ同化（SDA）
- Diffusion Posterior Sampling（DPS）
- 様々な観測モデルへの対応（線形/非線形、完全/不完全）

### 4. **計算最適化**
- SLURMによる並列ジョブ実行
- GPUアクセラレーション
- HDF5による効率的なデータI/O

## 実験評価指標

- **観測誤差**: `(A(x) - y*).std()`で評価
- **視覚的品質**: 渦度場の可視化による定性評価
- **物理的整合性**: Kolmogorov流の特性保持

## 使用方法の例

### データ生成
```python
# 1024個のシミュレーションを並列実行
for i in range(1024):
    simulate(i)

# データセットの作成
aggregate()
```

### モデル訓練
```python
# 3つの異なる初期化で訓練
for i in range(3):
    train(i)
```

### データ同化実験
```python
# スコアモデルのロード
score = load_score(model_path)

# SDEの設定
sde = VPSDE(GaussianScore(y_star, A=A, std=0.1, sde=VPSDE(score)))

# サンプリング
x = sde.sample(steps=256)
```

## まとめ

このコードベースは、物理シミュレーションと深層学習を組み合わせた最先端のデータ同化手法の実装です。Kolmogorov流という具体的な物理系を対象に、様々な観測条件下でのデータ同化性能を系統的に評価できる包括的な実験環境を提供しています。