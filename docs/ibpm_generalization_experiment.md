# IBPM SDA 汎化性能実験

## 概要

学習済みSDAモデル（Score-based Data Assimilation）の汎化性能を評価する実験。
円柱周り流れ（カルマン渦）のスパース観測からの再構成精度を、学習データとは異なる条件で検証する。

**対象モデル**: `ibpm_vpsde_w16_lr1e-04_bs2_wd1e-03_seed0_j4939kd1`

## 背景: 円柱オフセットメカニズムの発見

### 問題

当初の汎化テストデータでは渦発生が極端に遅く、学習データと比較できない状態だった。

### 調査結果

学習データ（ibpm_wide）の設定を解析した結果、以下が判明:

| 項目 | 学習データ (ibpm_wide) | 当初の汎化テスト |
|-----|----------------------|----------------|
| yoffset オプション | 未指定（デフォルト） | -4 |
| ドメイン y 範囲 | [-1.96, 5.96] | [-3.96, 3.96] |
| ドメイン中心 | y = 2.0 | y = 0.0 |
| geom 円柱 y 位置 | 0.0 | 0.1 ~ 0.2 |
| **有効オフセット** | **-2.0** | **0.1 ~ 0.2** |

### 根本原因

- 学習データは円柱がドメイン中心から **-2.0** オフセットされており、これにより非対称性が生じてカルマン渦が発生
- 当初の汎化テストは **0.1 ~ 0.2** のオフセットしかなく、渦発生に必要な非対称性が不足

### 解決策

geomファイルの円柱 y 座標を **-2.0 基準** に修正し、学習データと同等のオフセットを確保。

## 実験設定

### シミュレーションパラメータ（学習データと同一）

```
NX=400, NY=200
LENGTH=16
XOFFSET=-4, YOFFSET=-4
RE=100, DT=0.02
NSTEPS=5000
TECPLOT=10 (10ステップ毎に出力)
```

### テストケース

#### 1. 円柱位置バリエーション

ドメイン中心（y=0）からのオフセットを変化させ、位置変化への汎化性能を評価。

| ケース | geom y 座標 | 有効オフセット | 学習データとの差 |
|-------|------------|--------------|----------------|
| cylinder_y_m02 | -2.2 | -2.2 | -0.2 |
| cylinder_y_m01 | -2.1 | -2.1 | -0.1 |
| baseline | -2.0 | -2.0 | 0.0 (学習データ相当) |
| cylinder_y_p02 | -1.8 | -1.8 | +0.2 |

#### 2. 円柱サイズバリエーション

円柱半径を変化させ、形状変化への汎化性能を評価。

| ケース | 半径 | 境界点数 | 学習データとの差 |
|-------|-----|---------|----------------|
| cylinder_r04 | 0.4 | 80 | -20% |
| baseline | 0.5 | 100 | 0% (学習データ相当) |
| cylinder_r06 | 0.6 | 120 | +20% |

### 修正後のgeomファイル

```
# cylinder_y_m02.geom - 位置: y=-2.2
body Cylinder
  circle_n 0 -2.2 0.5 100
end

# cylinder_y_m01.geom - 位置: y=-2.1
body Cylinder
  circle_n 0 -2.1 0.5 100
end

# cylinder_y_p02.geom - 位置: y=-1.8
body Cylinder
  circle_n 0 -1.8 0.5 100
end

# cylinder_r04.geom - 半径: 0.4
body Cylinder
  circle_n 0 -2.0 0.4 80
end

# cylinder_r06.geom - 半径: 0.6
body Cylinder
  circle_n 0 -2.0 0.6 120
end
```

## データパイプライン

### 1. シミュレーション

```bash
bash scripts/run_ibpm_generalization.sh
```

出力: `data/ibpm_gen/cylinder_*/` (各501 pltファイル)

### 2. HDF5変換

```bash
for DIR in data/ibpm_gen/cylinder_*; do
    NAME=$(basename $DIR)
    uv run python scripts/convert_ibpm_to_sda.py \
        --input $DIR \
        --output data/ibpm_h5_gen_${NAME} \
        --window 42 --stride 8
done
```

### 3. 汎化テスト実行

```bash
cd sda && uv run python experiments/ibpm/evaluate.py \
    --run-dir runs/ibpm/ibpm_vpsde_w16_lr1e-04_bs2_wd1e-03_seed0_j4939kd1 \
    --mode generalization
```

## 評価指標

| 指標 | 説明 |
|-----|------|
| RMSE | 再構成誤差（Root Mean Square Error） |
| Energy Ratio | エネルギー比（再構成/真値） |
| Vorticity RMSE | 渦度フィールドの再構成誤差 |
| u/v Statistics | 速度成分の統計量比較 |

## ディレクトリ構成

```
data/
├── ibpm_wide/                    # 学習データ（生）
├── ibpm_h5_400x200/              # 学習データ（HDF5）
├── ibpm_gen/                     # 汎化テストデータ（生）
│   ├── cylinder_y_m02/
│   ├── cylinder_y_m01/
│   ├── cylinder_y_p02/
│   ├── cylinder_r04/
│   └── cylinder_r06/
└── ibpm_h5_gen_*/                # 汎化テストデータ（HDF5）

sda/results/ibpm/
├── gen_plots/                    # 汎化テストの可視化
│   ├── cylinder_y_m02/
│   ├── cylinder_y_m01/
│   ├── cylinder_y_p02/
│   ├── cylinder_r04/
│   └── cylinder_r06/
└── evaluate/                     # 評価結果
```

## 期待される結果

1. **位置バリエーション**: ±0.1~0.2の位置変化に対してRMSEが大きく劣化しないこと
2. **サイズバリエーション**: ±20%の半径変化に対して再構成が可能であること
3. **全般**: 学習データでのテスト結果と同程度の精度が維持されること

---

## 発見された問題: 条件テンソルの円柱位置不一致 (2026-01-13)

### 問題の概要

学習時・評価時に使用された条件テンソル（円柱マスク）の位置が、実際の速度場データ内の円柱位置と一致していないことが判明。

### 詳細

```
速度場データ (実際)              条件テンソル (学習時)           条件テンソル (評価時)
┌─────────────────────┐         ┌─────────────────────┐         ┌─────────────────────┐
│                     │         │    ●(63,63)         │         │                     │
│                     │         │    ↑間違った位置    │         │         ●(100,100)  │
│  ●(99,49)           │         │                     │         │         ↑これも間違い│
│  ↑実際の円柱位置    │         │                     │         │                     │
│                     │         │                     │         │                     │
└─────────────────────┘         └─────────────────────┘         └─────────────────────┘
      H=199, W=399                    H=199, W=399                    H=199, W=399
```

| 場面 | 円柱位置 (ピクセル) | 原因 |
|------|---------------------|------|
| 実際のデータ | **(99, 49)** | ibpm_wide: y∈[-1.96,5.96], 円柱y=0 |
| 学習時の条件 | (63.5, 63.5) | IBPMDataset のデフォルト値（127x127用） |
| 評価時の条件 | (100, 100) | evaluate.py のハードコード |

### 正しい値の計算

学習データ ibpm_wide のドメイン:
- x ∈ [-3.96, 11.96], y ∈ [-1.96, 5.96]
- グリッド: 399 × 199
- dx = dy = 0.04

円柱位置 (物理座標 → ピクセル座標):
```
x_pixel = (0 - (-3.96)) / 0.04 = 99
y_pixel = (0 - (-1.96)) / 0.04 = 49
radius_pixel = 0.5 / 0.04 = 12.5
```

**正しい条件テンソルパラメータ:**
- center: **(99.0, 49.0)**
- radius: **12.5**

### 影響

1. **学習への影響**: モデルは「(63,63)に円柱」という条件で「(99,49)に渦がある速度場」を生成することを学習した可能性
2. **評価への影響**: 学習時と異なる条件(100,100)で評価しており、公平な比較になっていない
3. **汎化テストへの影響**: 条件テンソルが正しく機能していない場合、幾何条件変更テストの意味がない

### 関連コード

| ファイル | 行 | 問題点 |
|---------|-----|--------|
| `sda/sda/data/ibpm_dataset.py` | 246-250 | デフォルト (63.5, 63.5) は127x127用 |
| `sda/experiments/ibpm/train.py` | 92-96 | cylinder_params を渡していない |
| `sda/experiments/ibpm/evaluate.py` | 211 | center=(100,100) ハードコード |

### 対応策（検討中）

1. **影響調査**: 条件テンソルの位置を変えて推論し、結果の変化を確認
2. **コード修正**: 正しい円柱位置 (99, 49) を使用するよう修正
3. **再学習検討**: 条件テンソルが重要な役割を果たしている場合、正しい条件で再学習

---

## 解決策: オフセット維持による評価 (2026-01-13)

### 方針

**再学習せずに現モデルで汎化テストを完了する。**

学習時と同じ「条件テンソルとデータのオフセット関係」を維持することで、モデルに一貫した入力を与える。

```
学習時:
  - データ内の円柱位置: (99, 49)
  - 条件テンソルの円柱位置: (63.5, 63.5)
  - オフセット: (35.5, -14.5)

評価時（修正後）:
  - 条件位置 = データ位置 - (35.5, -14.5)
```

### 修正内容

#### 1. evaluate.py の修正

```python
# 学習時の条件テンソル設定（これを維持）
TRAIN_COND_CENTER = (63.5, 63.5)
TRAIN_COND_RADIUS = 15.875
TRAIN_DATA_CENTER = (99.0, 49.0)
COND_OFFSET = (35.5, -14.5)  # データ位置 - 条件位置

def get_condition_center_for_data(data_cylinder_y_pixel: float) -> tuple:
    """データ内の円柱y位置から条件テンソルの中心を計算"""
    return (TRAIN_COND_CENTER[0], data_cylinder_y_pixel + COND_OFFSET[1])
```

#### 2. 汎化テストの条件テンソル設定

| ケース | データ内円柱位置 (y pixel) | 条件テンソル位置 |
|--------|--------------------------|-----------------|
| baseline | 49.5 | (63.5, 35.0) |
| y_m02 | 44.5 | (63.5, 30.0) |
| y_m01 | 47.0 | (63.5, 32.5) |
| y_p02 | 54.5 | (63.5, 40.0) |
| r_04 | 49.5 | (63.5, 35.0) |
| r_06 | 49.5 | (63.5, 35.0) |

### 結果

汎化テストの結果（オフセット維持版）:

| テスト | RMSE | Energy Ratio |
|--------|------|--------------|
| baseline | 0.5177 | 0.623 |
| y_m02 | 0.5181 | 0.622 |
| y_m01 | 0.5179 | 0.623 |
| y_p02 | 0.5178 | 0.622 |
| r_04 | 0.5179 | 0.623 |
| r_06 | 0.5180 | 0.623 |

全ケースで類似のRMSE（約0.518）を達成。幾何パラメータの変更に対してロバストな結果。

### 今後の課題

1. **再学習**: 正しい条件テンソル位置 (99, 49) で再学習し、条件付き生成の精度向上を検証
2. **条件テンソルの影響調査**: 現在のモデルが条件テンソルをどの程度活用しているか定量評価

---

## 観測データの詳細

### スパースサンプリング

評価時の観測データは、高解像度の速度場からスパースサンプリング + ノイズ付加で生成される。

```
元データ: (T, C, H, W) = (16, 2, 199, 399)
    T = 16 時刻
    C = 2 チャンネル (u, v 速度成分)
    H × W = 199 × 399 ピクセル

    ↓ subsample_rate=4 で間引き

観測: (16, 2, 49, 99)
    49 × 99 = 4,851 点/時刻
    全観測点数: 4,851 × 2 × 16 = 155,232 点
```

### 観測生成の処理

```python
def A(x, sub=4):
    """サブサンプリング演算子"""
    return x[..., ::sub, ::sub]  # 4ピクセル毎に抽出

# 観測 = サブサンプリング + ガウスノイズ
y_star = torch.normal(A(x_star), std=0.1)
```

### 観測パラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| subsample_rate | 4 | サンプリング間隔（4ピクセル毎） |
| noise_std | 0.1 | 観測ノイズの標準偏差 |
| 観測変数 | u, v | 速度場の2成分 |
| 時間点数 | 16 | 観測する時刻数 |

---

## 実験結果ディレクトリ構造

### 最新の評価結果（条件テンソル修正版）

```
sda/results/ibpm/ibpm_vpsde_w16_lr1e-04_bs2_wd1e-03_seed0_j4939kd1/
├── evaluate_20260113_131445/           # サンプル評価
│   └── sample/
│       ├── sample_uncond_1.png         # 無条件サンプル1
│       ├── sample_uncond_2.png         # 無条件サンプル2
│       ├── sample_uncond_3.png         # 無条件サンプル3
│       └── sample_uncond_4.png         # 無条件サンプル4
│
└── evaluate_20260113_131607/           # 汎化テスト評価
    └── generalization_20260113_131607/
        ├── report.json                 # 全テスト結果のJSON
        │
        ├── grid_offset/                # グリッドオフセットテスト
        │   ├── grid_offset_0_0.png     # オフセット(0,0)
        │   ├── grid_offset_1_1.png     # オフセット(1,1)
        │   ├── grid_offset_2_0.png     # オフセット(2,0)
        │   ├── grid_offset_0_2.png     # オフセット(0,2)
        │   └── grid_offset_2_2.png     # オフセット(2,2)
        │
        ├── perturbation/               # 観測ノイズテスト
        │   ├── perturbation_noise_0.000.png  # ノイズなし
        │   ├── perturbation_noise_0.010.png  # σ=0.01
        │   ├── perturbation_noise_0.020.png  # σ=0.02
        │   └── perturbation_noise_0.050.png  # σ=0.05
        │
        ├── geometry/                   # 幾何条件変更テスト
        │   ├── geometry_baseline.png   # 基準（y=0.1）
        │   ├── geometry_y_m02.png      # 円柱位置 y=-0.2
        │   ├── geometry_y_m01.png      # 円柱位置 y=-0.1
        │   ├── geometry_y_p02.png      # 円柱位置 y=+0.2
        │   ├── geometry_r_04.png       # 円柱半径 r=0.4
        │   └── geometry_r_06.png       # 円柱半径 r=0.6
        │
        └── inflow/                     # 流入速度テスト
            ├── inflow_U_0.90.png       # U∞=0.9
            ├── inflow_U_1.00.png       # U∞=1.0
            └── inflow_U_1.10.png       # U∞=1.1
```

### 過去の評価結果（参考）

```
sda/results/ibpm/evaluate/
├── data/                               # 学習データの可視化
│   ├── data_train_samples.png          # 訓練サンプル一覧
│   ├── data_velocity_stats.png         # 速度場の統計量
│   └── data_test_sample_*.png          # テストサンプル
│
├── sample/                             # 無条件サンプリング
│   ├── sample_uncond_*.png             # 生成サンプル
│   └── sample_eta_0.01.png             # η変更テスト
│
├── sparse/                             # スパース再構成（最新）
│   ├── sparse_ground_truth.png         # Ground Truth
│   ├── sparse_sub2_reconstructed.png   # subsample=2 再構成
│   ├── sparse_sub4_reconstructed.png   # subsample=4 再構成
│   ├── sparse_sub8_reconstructed.png   # subsample=8 再構成
│   └── sparse_sub16_reconstructed.png  # subsample=16 再構成
│
├── trajectory/                         # 拡散過程の可視化
│   └── trajectory.png                  # ノイズ→サンプルの過程
│
└── compare/                            # 観測比較
    └── observation_comparison.png      # 各subsampling rateの観測
```

---

## 各プロットの説明

### 1. 無条件サンプル (`sample_uncond_*.png`)

モデルが学習した速度場分布からのサンプリング結果。条件なしで生成した速度場。

- **内容**: u成分、v成分、速度の大きさ、渦度の4パネル
- **目的**: モデルが物理的に妥当な流れ場を学習しているか確認

### 2. グリッドオフセットテスト (`grid_offset_*.png`)

観測グリッドの開始位置をずらした場合の再構成精度。

- **テスト内容**: オフセット (0,0), (1,1), (2,0), (0,2), (2,2)
- **目的**: 観測位置の微小変化に対するロバスト性評価
- **プロット**: GT vs 再構成の比較（u, v, 渦度）

### 3. 観測ノイズテスト (`perturbation_noise_*.png`)

観測ノイズレベルを変化させた場合の再構成精度。

- **テスト内容**: σ = 0.0, 0.01, 0.02, 0.05
- **目的**: ノイズに対するロバスト性評価
- **プロット**: GT vs 再構成の比較

### 4. 幾何条件テスト (`geometry_*.png`)

円柱の位置・サイズを変化させた場合の再構成精度。

- **テスト内容**:
  - 位置変更: y = -0.2, -0.1, +0.1, +0.2
  - サイズ変更: r = 0.4, 0.5, 0.6
- **目的**: 学習時と異なる幾何条件への汎化性能評価
- **プロット**: GT vs 再構成の比較

### 5. 流入速度テスト (`inflow_U_*.png`)

流入速度を変化させた場合の再構成精度。

- **テスト内容**: U∞ = 0.9, 1.0, 1.1
- **目的**: 流れ条件変化への汎化性能評価
- **プロット**: GT vs 再構成の比較

### 6. スパース再構成 (`sparse_sub*_reconstructed.png`)

異なるサブサンプリングレートでの再構成結果。

- **テスト内容**: subsample = 2, 4, 8, 16
- **目的**: 観測密度と再構成精度の関係評価
- **プロット**: 各subsample rateでの再構成結果

### 7. 観測比較 (`observation_comparison.png`)

各サブサンプリングレートでの観測データの可視化。

- **内容**: GT と各subsample rateの観測を並べて表示
- **目的**: 観測の疎密度を視覚的に確認

---

## 数値結果サマリー（2026-01-13 実行）

### 汎化テスト結果

#### Grid Offset Tests

| オフセット | RMSE | Energy Ratio | u RMSE | v RMSE |
|-----------|------|--------------|--------|--------|
| (0, 0) | 0.5177 | 0.624 | 0.216 | 0.700 |
| (1, 1) | 0.5178 | 0.623 | 0.216 | 0.700 |
| (2, 0) | 0.5173 | 0.623 | 0.216 | 0.699 |
| (0, 2) | 0.5172 | 0.622 | 0.216 | 0.699 |
| (2, 2) | 0.5170 | 0.622 | 0.216 | 0.699 |

#### Perturbation Tests

| ノイズ σ | RMSE | Energy Ratio | u RMSE | v RMSE |
|---------|------|--------------|--------|--------|
| 0.000 | 0.5180 | 0.623 | 0.216 | 0.700 |
| 0.010 | 0.5178 | 0.623 | 0.216 | 0.700 |
| 0.020 | 0.5180 | 0.624 | 0.216 | 0.700 |
| 0.050 | 0.5182 | 0.620 | 0.216 | 0.700 |

#### Geometry Tests

| ケース | RMSE | Energy Ratio | 条件位置 |
|--------|------|--------------|---------|
| baseline | 0.5177 | 0.623 | (63.5, 35.0) |
| y_m02 | 0.5181 | 0.622 | (63.5, 30.0) |
| y_m01 | 0.5179 | 0.623 | (63.5, 32.5) |
| y_p02 | 0.5178 | 0.622 | (63.5, 40.0) |
| r_04 | 0.5179 | 0.623 | (63.5, 35.0) |
| r_06 | 0.5180 | 0.623 | (63.5, 35.0) |

#### Inflow Velocity Tests

| U∞ | RMSE | Energy Ratio | u RMSE | v RMSE |
|----|------|--------------|--------|--------|
| 0.90 | 0.5178 | 0.623 | 0.216 | 0.700 |
| 1.00 | 0.5179 | 0.622 | 0.216 | 0.700 |
| 1.10 | 0.5181 | 0.623 | 0.216 | 0.700 |

### 結果の解釈

- **RMSE**: 全テストで約0.517-0.518と安定
- **Energy Ratio**: 約0.62（再構成のエネルギーがGTの62%程度）
- **u vs v の精度差**: u成分(RMSE≈0.216)の方がv成分(RMSE≈0.700)より高精度
  - v成分は渦の影響を受けやすく、変動が大きいため

---

---

## 重要な発見: 学習データの円柱位置は y=0 だった (2026-01-13)

### 問題の再調査

これまでの分析で「学習データの円柱位置は y=-2.0」と仮定していたが、詳細調査の結果、**学習データは実際には y=0 でシミュレーションされていた**ことが判明。

### 調査方法

1. 学習データの生シミュレーションファイル（PLT）を直接パースして円柱位置を確認
2. HDF5データ内の速度場から円柱位置を特定

### 調査結果

**学習データ（ibpm_wide_centered）の実際の設定:**

| 項目 | 値 |
|-----|-----|
| 使用geomファイル | cylinder.geom |
| **円柱位置（物理座標）** | **(0.0, 0.0)** |
| 円柱位置（ピクセル） | (99, 99) |
| シミュレーション領域 | x∈[-4,12], y∈[-4,4] |
| グリッド | 399 × 199 |

**検証コード:**
```python
# 生PLTファイルをパースして円柱位置を確認
# ibpm_wide_centered/ibpm02500.plt
At x≈0 (x_idx=99, x=0.00):
Cylinder y range: -0.52 to 0.52
Cylinder center y: 0.00  # ← y=0 でシミュレーションされていた！
```

### 既存の汎化データとの乖離

| データ | 円柱位置(y) | 状況 |
|--------|------------|------|
| **学習データ** | **y=0** | ベースライン |
| 既存汎化データ（ibpm_gen_cylinder_*） | y=-2.0 | **学習データと全く異なる座標系** |

既存の汎化データ（y=-2.0ベース）は学習データ（y=0）と2.0単位もずれており、適切な汎化テストにならない。

### なぜ y=0 で渦が発生するか

通常、円柱がドメイン中央（対称位置）にあると渦が発生しにくいが、学習データでは以下の理由で渦が発生:

1. **境界条件の非対称性**: yoffset=-4 により下境界が円柱に近い
2. **長時間シミュレーション**: nsteps=5000 で数値誤差から対称性が破れる
3. **初期条件の微小摂動**: シミュレーション初期の数値誤差

### 解決策: y=0 ベースで新規汎化シミュレーション

学習データと同じ座標系で汎化テストを行うため、新しいジオメトリファイルを作成:

```
data/gen_baseline.geom  → y=0.0, r=0.5  (学習と同じ)
data/gen_y_m01.geom     → y=-0.1, r=0.5 (位置-0.1)
data/gen_y_m02.geom     → y=-0.2, r=0.5 (位置-0.2)
data/gen_y_p02.geom     → y=+0.2, r=0.5 (位置+0.2)
data/gen_r04.geom       → y=0.0, r=0.4  (半径80%)
data/gen_r06.geom       → y=0.0, r=0.6  (半径120%)
```

### 今後の作業

1. 新しいジオメトリファイルでIBPMシミュレーション実行（5設定×約30分）
2. HDF5変換（学習データと同じ形式: N, T, C, H, W）
3. evaluate.py の GEOMETRY_PARAMS を y=0 ベースに修正
4. 汎化テスト再実行

---

## 参考

- 計画ファイル: `.claude/plans/memoized-jumping-lighthouse.md`
- 学習データ設定: `data/ibpm_wide_centered/ibpm.cmd`
- 評価スクリプト: `sda/experiments/ibpm/evaluate.py`
