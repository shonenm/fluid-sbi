# IBPM 実験トラブルシューティング記録

IBPM円柱周り流れデータに Score-Based Data Assimilation を適用した際の問題と解決策。

---

## 背景: VP-SDE と正規化

VP-SDE は**入力データが N(0, 1) 分布**であることを仮定している。

| データ状態 | mean | std | VP-SDE との整合性 |
|-----------|------|-----|------------------|
| 生データ | ≈ 1.0 (u成分) | ≈ 0.5 | ❌ |
| チャネル正規化後 | ≈ 0 | ≈ 0.55 | △ |
| GLOBAL_SCALE 適用後 | ≈ 0 | ≈ 1.0 | ✅ |

**なぜ2段階正規化が必要か:**
- 流入速度 U=1 のため u 成分の平均が 1
- u と v の std が異なる（0.247, 0.151）ため、チャネル正規化だけでは全体 std ≈ 0.55
- GLOBAL_SCALE = 0.55 で割ることで std ≈ 1.0 に調整

---

## 問題1: 生成画像が真っ白になる

### 症状
- 生成画像が全て真っ白
- 訓練損失は正常に収束（0.36 → 0.005）

### 根本原因: 正規化 + eta の複合問題

**両方の修正が必要。どちらか一方では解決しない。**

| 修正状態 | 正規化 | eta | 結果 |
|----------|--------|-----|------|
| 初期状態 | ❌ | 0.001 | 真っ白 |
| 正規化のみ | ✅ | 0.001 | まだ白い |
| **両方** | ✅ | **0.01** | **渦が見える** |

#### 原因1: データ正規化の欠如
- `IBPMDataset` が正規化せずに生データを返していた
- モデルが学習する分布と VP-SDE の仮定が不整合

#### 原因2: eta パラメータ
| eta | mu(1.0) | サンプリング係数 r | 結果 |
|-----|---------|-------------------|------|
| 0.001 | 0.001 | 16.25 | 発散 |
| **0.01** | 0.01 | **1.51** | **安定** |

- `eta=0.001` では `mu(1.0) = 0.001`（極端に小さい）
- サンプリング初期の係数が巨大化 → 数値的に不安定

### 解決策
1. `IBPMDataset` に `normalize=True` を追加
2. 全ての `VPSDE()` に `eta=0.01` を指定
3. 再訓練

### 結果
- カルマン渦構造が可視化可能に
- ただし渦度強度は訓練データの約70%

---

## 問題2: 生成精度が低い

### 症状
渦構造は見えるが、強度が弱い：

| 指標 | 訓練データ | 生成サンプル | 比率 |
|------|-----------|-------------|------|
| 渦度 min | -0.74 | -0.52 | 70% |
| 渦度 max | 0.66 | 0.19 | 29% |
| 正規化 std | 0.55 | 1.89 | 不整合 |

### 原因
1. **正規化の不整合**: 訓練データ std ≈ 0.55 だが、VP-SDE は std = 1.0 を仮定
2. **訓練不足**: 100 epochs（Kolmogorov は 4096 epochs）

### 解決策
1. `GLOBAL_SCALE = 0.55` を導入 → 正規化後 std ≈ 1.0
2. `epochs: 500` に増加
3. 再訓練（実行中）

---

## Kolmogorov との比較

| 項目 | Kolmogorov | IBPM |
|------|-----------|------|
| 解像度 | 64×64 | 199×399 |
| 境界条件 | 周期的 | 非周期的 |
| eta | 0.001 | **0.01** |
| epochs | 4096 | 500 |
| データ正規化 | なし | **必須** |

### 教訓
1. **eta**: 高解像度・非周期境界では `eta=0.01` が安定
2. **正規化**: 流入速度 U≠0 のデータは2段階正規化が必要
3. **訓練量**: 十分なエポック数が必要
